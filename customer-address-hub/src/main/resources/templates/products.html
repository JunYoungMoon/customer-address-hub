<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>μ„ λ¬Όμ„ΈνΈ μ„ νƒ</title>
</head>
<body>
<div layout:fragment="content">
    <!-- ν† μ¤νΈ λ©”μ‹μ§€ -->
    <div id="toast" class="toast">
        <span class="toast-icon">β“</span>
        <span class="toast-message"></span>
    </div>

    <div class="customer-info">
        <span th:text="${customer.name}">ν™κΈΈλ™</span>λ‹ ν™μν•©λ‹λ‹¤!
        (<span th:text="${customer.phone}">010-1234-5678</span>)
    </div>

    <div class="content">
        <div class="products">
            <!-- κ°λΉ„ μ„ λ¬Όμ„ΈνΈ -->
            <div class="product-card">
                <img src="/images/product1.jpg" alt="κ°λΉ„ μ„ λ¬Όμ„ΈνΈ" class="product-image"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="product-image-placeholder" style="display:none;">π¥©</div>

                <div class="product-info">
                    <div class="product-name">ν”„λ¦¬λ―Έμ—„ κ°λΉ„ μ„ λ¬Όμ„ΈνΈ</div>
                    <div class="product-description">μµκ³ κΈ‰ ν•μ° κ°λΉ„λ΅ λ§λ“  ν”„λ¦¬λ―Έμ—„ μ„ λ¬Όμ„ΈνΈμ…λ‹λ‹¤. λ…μ κ³Ό νΉλ³„ν• λ‚  μ„ λ¬Όλ΅ μ™„λ²½ν•©λ‹λ‹¤.</div>

                    <!-- μ΄λ―Έ μ¥λ°”κµ¬λ‹μ— λ‹΄κΈ΄ μλ‰ ν‘μ‹ -->
                    <div class="cart-status" id="galbi-cart-status" style="display:none;">
                        π›’ μ¥λ°”κµ¬λ‹μ— <span id="galbi-cart-count">0</span>κ° λ‹΄κΉ€
                    </div>

                    <div class="quantity-controls">
                        <span class="quantity-label">μλ‰ μ„ νƒ</span>
                        <div class="quantity-selector">
                            <button type="button" class="quantity-btn" onclick="decreaseQuantity('galbi')">-</button>
                            <span class="quantity-display" id="galbi-quantity">0</span>
                            <button type="button" class="quantity-btn" onclick="increaseQuantity('galbi')">+</button>
                        </div>
                    </div>

                    <button class="add-to-cart" onclick="addToCart('galbi')" id="galbi-add-btn" disabled>
                        <span class="original-text">μ¥λ°”κµ¬λ‹μ— μ¶”κ°€</span>
                    </button>
                </div>
            </div>

            <!-- μ¤νΈ μ„ λ¬Όμ„ΈνΈ -->
            <div class="product-card">
                <img src="/images/product2.jpg" alt="μ¤νΈ μ„ λ¬Όμ„ΈνΈ" class="product-image"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="product-image-placeholder" style="display:none;">π¥«</div>

                <div class="product-info">
                    <div class="product-name">ν”„λ¦¬λ―Έμ—„ μ¤νΈ μ„ λ¬Όμ„ΈνΈ</div>
                    <div class="product-description">μ •μ„±μ¤λ½κ² μ„ λ³„ν• ν”„λ¦¬λ―Έμ—„ μ¤νΈ μ„ λ¬Όμ„ΈνΈμ…λ‹λ‹¤. μ‹¤μ©μ μ΄κ³  λ§›μλ” μ„ λ¬Όμ…λ‹λ‹¤.</div>

                    <!-- μ΄λ―Έ μ¥λ°”κµ¬λ‹μ— λ‹΄κΈ΄ μλ‰ ν‘μ‹ -->
                    <div class="cart-status" id="spam-cart-status" style="display:none;">
                        π›’ μ¥λ°”κµ¬λ‹μ— <span id="spam-cart-count">0</span>κ° λ‹΄κΉ€
                    </div>

                    <div class="quantity-controls">
                        <span class="quantity-label">μλ‰ μ„ νƒ</span>
                        <div class="quantity-selector">
                            <button type="button" class="quantity-btn" onclick="decreaseQuantity('spam')">-</button>
                            <span class="quantity-display" id="spam-quantity">0</span>
                            <button type="button" class="quantity-btn" onclick="increaseQuantity('spam')">+</button>
                        </div>
                    </div>

                    <button class="add-to-cart" onclick="addToCart('spam')" id="spam-add-btn" disabled>
                        <span class="original-text">μ¥λ°”κµ¬λ‹μ— μ¶”κ°€</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="cart-footer">
        <div class="cart-info">
            μ¥λ°”κµ¬λ‹: <span id="cart-count">0</span>κ° μƒν’
        </div>
        <button class="go-cart-btn" onclick="location.href='/cart'" id="cart-btn" disabled>
            μ¥λ°”κµ¬λ‹ λ³΄κΈ°
        </button>
    </div>
</div>

<script layout:fragment="scripts">
    let cart = { galbi: 0, spam: 0 };
    let quantities = { galbi: 0, spam: 0 };

    // νμ΄μ§€ λ΅λ“ μ‹ μ„λ²„μ™€ λ™κΈ°ν™”
    window.addEventListener('DOMContentLoaded', function() {
        syncCartWithServer();
    });

    function syncCartWithServer() {
        console.log("=== μ„λ²„μ™€ μ¥λ°”κµ¬λ‹ λ™κΈ°ν™” ===");

        fetch('/api/cart/status')
            .then(response => {
                if (response.status === 401) {
                    // μΈμ¦ μ¤λ¥ μ‹ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                    location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log("μ„λ²„μ—μ„ λ°›μ€ μ¥λ°”κµ¬λ‹ λ°μ΄ν„°:", data);

                    cart.galbi = data.galbiQuantity || 0;
                    cart.spam = data.spamQuantity || 0;

                    console.log("λ™κΈ°ν™”λ cart:", cart);

                    updateCartDisplay();
                    updateCartStatusDisplay();
                    updateQuantityDisplay('galbi');
                    updateQuantityDisplay('spam');
                }
            })
            .catch(error => {
                console.error("μ¥λ°”κµ¬λ‹ λ™κΈ°ν™” μ‹¤ν¨:", error);
                // ν΄λ°±: μ„λ²„ μ‚¬μ΄λ“ λ λ”λ§ κ°’ μ‚¬μ©
                cart.galbi = /*[[${cart.galbiQuantity}]]*/ 0;
                cart.spam = /*[[${cart.spamQuantity}]]*/ 0;

                updateCartDisplay();
                updateQuantityDisplay('galbi');
                updateQuantityDisplay('spam');
            });
    }

    function updateCartStatusDisplay() {
        // κ°λΉ„ μ¥λ°”κµ¬λ‹ μƒνƒ
        const galbiStatus = document.getElementById('galbi-cart-status');
        const galbiCount = document.getElementById('galbi-cart-count');

        if (cart.galbi > 0) {
            galbiCount.textContent = cart.galbi;
            galbiStatus.style.display = 'block';
        } else {
            galbiStatus.style.display = 'none';
        }

        // μ¤νΈ μ¥λ°”κµ¬λ‹ μƒνƒ
        const spamStatus = document.getElementById('spam-cart-status');
        const spamCount = document.getElementById('spam-cart-count');

        if (cart.spam > 0) {
            spamCount.textContent = cart.spam;
            spamStatus.style.display = 'block';
        } else {
            spamStatus.style.display = 'none';
        }
    }

    function increaseQuantity(product) {
        if (quantities[product] < 20) {
            quantities[product]++;
            updateQuantityDisplay(product);
        }
    }

    function decreaseQuantity(product) {
        if (quantities[product] > 0) {
            quantities[product]--;
            updateQuantityDisplay(product);
        }
    }

    function updateQuantityDisplay(product) {
        document.getElementById(product + '-quantity').textContent = quantities[product];
        document.getElementById(product + '-add-btn').disabled = quantities[product] === 0;
    }

    function updateCartDisplay() {
        const totalItems = cart.galbi + cart.spam;
        const cartCountElement = document.getElementById('cart-count');
        const cartBtnElement = document.getElementById('cart-btn');

        if (cartCountElement) {
            cartCountElement.textContent = totalItems;
            cartCountElement.classList.add('cart-count-animation');
            setTimeout(() => {
                cartCountElement.classList.remove('cart-count-animation');
            }, 500);
        }

        if (cartBtnElement) {
            cartBtnElement.disabled = totalItems === 0;
        }
    }

    function addToCart(product) {
        console.log("=== addToCart ν•¨μ μ‹¤ν–‰ ===");
        console.log("μƒν’:", product);
        console.log("μ¶”κ°€ν•  μλ‰:", quantities[product]);

        if (quantities[product] > 0) {
            const button = document.getElementById(product + '-add-btn');
            const originalText = button.querySelector('.original-text');
            const qtyToAdd = quantities[product];

            // λ΅λ”© μƒνƒ ν‘μ‹
            button.classList.add('btn-loading');
            button.disabled = true;
            originalText.textContent = 'μ¶”κ°€ μ¤‘...';

            // REST API νΈμ¶
            const formData = new FormData();
            formData.append('galbiQuantity', product === 'galbi' ? qtyToAdd : 0);
            formData.append('spamQuantity', product === 'spam' ? qtyToAdd : 0);
            formData.append('action', 'add');

            fetch('/api/cart/modify', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.status === 401) {
                        // μΈμ¦ μ¤λ¥ μ‹ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                        location.href = '/login';
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        // μ„±κ³µν•λ©΄ λ΅μ»¬ μƒνƒ μ—…λ°μ΄νΈ
                        cart[product] += qtyToAdd;
                        quantities[product] = 0;

                        updateQuantityDisplay(product);
                        updateCartDisplay();
                        updateCartStatusDisplay();

                        // μ„±κ³µ ν† μ¤νΈ λ©”μ‹μ§€ ν‘μ‹
                        const productName = product === 'galbi' ? 'κ°λΉ„ μ„ λ¬Όμ„ΈνΈ' : 'μ¤νΈ μ„ λ¬Όμ„ΈνΈ';
                        showToast(`${productName} ${qtyToAdd}κ°κ°€ μ¥λ°”κµ¬λ‹μ— μ¶”κ°€λμ—μµλ‹λ‹¤!`, 'success');
                    } else {
                        showToast(data?.message || 'μ¥λ°”κµ¬λ‹ μ¶”κ°€μ— μ‹¤ν¨ν–μµλ‹λ‹¤.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.', 'error');
                })
                .finally(() => {
                    // λ΅λ”© μƒνƒ ν•΄μ 
                    button.classList.remove('btn-loading');
                    button.disabled = quantities[product] === 0;
                    originalText.textContent = 'μ¥λ°”κµ¬λ‹μ— μ¶”κ°€';
                });
        } else {
            showToast('μλ‰μ„ μ„ νƒν•΄μ£Όμ„Έμ”!', 'error');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = toast.querySelector('.toast-message');
        const toastIcon = toast.querySelector('.toast-icon');

        toastMessage.textContent = message;
        toastIcon.textContent = type === 'success' ? 'β“' : 'β—';

        toast.className = `toast ${type}`;

        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
</body>
</html>