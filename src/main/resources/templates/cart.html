<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>μ¥λ°”κµ¬λ‹</title>
</head>
<body>
<div layout:fragment="content">
    <div class="page-header">
        <button class="back-btn" onclick="history.back()">β†</button>
        <h1 class="page-title">π›’ μ¥λ°”κµ¬λ‹</h1>
    </div>

    <div class="content">
        <div class="cart-items" th:if="${!cart.isEmpty()}">
            <!-- κ°λΉ„ μ„ λ¬Όμ„ΈνΈ -->
            <div class="cart-item" th:if="${cart.galbiQuantity > 0}">
                <div class="item-header">
                    <img src="/images/product1.jpg" alt="κ°λΉ„ μ„ λ¬Όμ„ΈνΈ" class="item-image"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="item-image-placeholder" style="display:none;">π¥©</div>

                    <div class="item-info">
                        <div class="item-name">ν”„λ¦¬λ―Έμ—„ κ°λΉ„ μ„ λ¬Όμ„ΈνΈ</div>
                        <div class="item-description">μµκ³ κΈ‰ ν•μ° κ°λΉ„λ΅ λ§λ“  ν”„λ¦¬λ―Έμ—„ μ„ λ¬Όμ„ΈνΈ</div>
                    </div>
                </div>

                <div class="quantity-controls">
                    <span class="quantity-label">μλ‰</span>
                    <div class="quantity-selector">
                        <button class="quantity-btn" onclick="updateQuantity('galbi', -1)">-</button>
                        <span class="quantity-display" id="galbi-qty" th:text="${cart.galbiQuantity}">1</span>
                        <button class="quantity-btn" onclick="updateQuantity('galbi', 1)">+</button>
                    </div>
                </div>

                <button class="remove-btn" onclick="removeItem('galbi')">μƒν’ μ‚­μ </button>
            </div>

            <!-- μ¤νΈ μ„ λ¬Όμ„ΈνΈ -->
            <div class="cart-item" th:if="${cart.spamQuantity > 0}">
                <div class="item-header">
                    <img src="/images/product2.jpg" alt="μ¤νΈ μ„ λ¬Όμ„ΈνΈ" class="item-image"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="item-image-placeholder" style="display:none;">π¥«</div>

                    <div class="item-info">
                        <div class="item-name">ν”„λ¦¬λ―Έμ—„ μ¤νΈ μ„ λ¬Όμ„ΈνΈ</div>
                        <div class="item-description">μ •μ„±μ¤λ½κ² μ„ λ³„ν• ν”„λ¦¬λ―Έμ—„ μ¤νΈ μ„ λ¬Όμ„ΈνΈ</div>
                    </div>
                </div>

                <div class="quantity-controls">
                    <span class="quantity-label">μλ‰</span>
                    <div class="quantity-selector">
                        <button class="quantity-btn" onclick="updateQuantity('spam', -1)">-</button>
                        <span class="quantity-display" id="spam-qty" th:text="${cart.spamQuantity}">1</span>
                        <button class="quantity-btn" onclick="updateQuantity('spam', 1)">+</button>
                    </div>
                </div>

                <button class="remove-btn" onclick="removeItem('spam')">μƒν’ μ‚­μ </button>
            </div>
        </div>

        <!-- λΉ μ¥λ°”κµ¬λ‹ -->
        <div class="empty-cart" th:if="${cart.isEmpty()}">
            <div class="empty-cart-icon">π›’</div>
            <h3>μ¥λ°”κµ¬λ‹κ°€ λΉ„μ–΄μμµλ‹λ‹¤</h3>
            <p>μ„ λ¬Όμ„ΈνΈλ¥Ό μ„ νƒν•΄λ³΄μ„Έμ”!</p>
        </div>

        <!-- μ£Όλ¬Έ μ”μ•½ -->
        <div class="summary" th:if="${!cart.isEmpty()}">
            <div class="summary-title">π“‹ μ£Όλ¬Έ μ”μ•½</div>
            <div class="summary-row" th:if="${cart.galbiQuantity > 0}">
                <span>κ°λΉ„ μ„ λ¬Όμ„ΈνΈ Γ— <span th:text="${cart.galbiQuantity}">1</span></span>
                <span>μ„ νƒλ¨</span>
            </div>
            <div class="summary-row" th:if="${cart.spamQuantity > 0}">
                <span>μ¤νΈ μ„ λ¬Όμ„ΈνΈ Γ— <span th:text="${cart.spamQuantity}">1</span></span>
                <span>μ„ νƒλ¨</span>
            </div>

            <div class="summary-row summary-total">
                <span>μ΄ μƒν’ μλ‰</span>
                <span id="total-items" th:text="${cart.galbiQuantity + cart.spamQuantity}">2</span>κ°
            </div>
        </div>
    </div>

    <div class="cart-footer">
        <button class="continue-shopping" onclick="location.href='/products'">κ³„μ† μ‡Όν•‘</button>
        <button class="checkout-btn" th:disabled="${cart.isEmpty()}" onclick="proceedToCheckout()">
            μ£Όλ¬Έν•κΈ°
        </button>
    </div>
</div>

<script layout:fragment="scripts">
    // μ„λ²„μ—μ„ μ „λ‹¬λ μ΄κΈ°κ°’μΌλ΅ μ„¤μ •
    let cartData = {
        galbi: /*[[${cart != null ? cart.galbiQuantity : 0}]]*/ 0,
        spam: /*[[${cart != null ? cart.spamQuantity : 0}]]*/ 0
    };

    console.log("μ΄κΈ° cartData:", cartData);

    function updateQuantity(product, change) {
        const currentQty = cartData[product];
        const newQty = Math.max(0, Math.min(20, currentQty + change));

        if (newQty !== currentQty) {
            cartData[product] = newQty;
            console.log("cartData μ—…λ°μ΄νΈ:", cartData);
            updateDisplay();
            updateServer();
        }
    }

    function removeItem(product) {
        if (confirm('μ΄ μƒν’μ„ μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) {
            cartData[product] = 0;
            console.log("μƒν’ μ‚­μ  ν›„ cartData:", cartData);
            updateDisplay();
            updateServer();
            location.reload();
        }
    }

    function updateDisplay() {
        if (cartData.galbi > 0) {
            const galbiQtyElement = document.getElementById('galbi-qty');
            if (galbiQtyElement) galbiQtyElement.textContent = cartData.galbi;
        }

        if (cartData.spam > 0) {
            const spamQtyElement = document.getElementById('spam-qty');
            if (spamQtyElement) spamQtyElement.textContent = cartData.spam;
        }

        const totalItems = cartData.galbi + cartData.spam;
        const totalElement = document.getElementById('total-items');
        if (totalElement) totalElement.textContent = totalItems;
    }

    function updateServer() {
        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cartData)
        }).then(response => {
            console.log("μ„λ²„ μ—…λ°μ΄νΈ μ™„λ£:", response.status);
        }).catch(error => {
            console.error("μ„λ²„ μ—…λ°μ΄νΈ μ‹¤ν¨:", error);
        });
    }

    function proceedToCheckout() {
        console.log("=== μ£Όλ¬Έν•κΈ° ν΄λ¦­ ===");
        console.log("ν„μ¬ cartData:", cartData);

        // cartDataκ°€ λΉ„μ–΄μμΌλ©΄ DOMμ—μ„ λ‹¤μ‹ μ½μ–΄λ³΄κΈ°
        if (cartData.galbi === 0 && cartData.spam === 0) {
            console.log("cartDataκ°€ λΉ„μ–΄μμ, DOMμ—μ„ μ¬ν™•μΈ");

            const galbiElement = document.getElementById('galbi-qty');
            const spamElement = document.getElementById('spam-qty');

            if (galbiElement) cartData.galbi = parseInt(galbiElement.textContent) || 0;
            if (spamElement) cartData.spam = parseInt(spamElement.textContent) || 0;

            console.log("DOMμ—μ„ λ‹¤μ‹ μ½μ€ cartData:", cartData);
        }

        if (cartData.galbi > 0 || cartData.spam > 0) {
            console.log("μ£Όλ¬Έ μ§„ν–‰!");
            location.href = '/address';
        } else {
            console.log("μ¥λ°”κµ¬λ‹κ°€ λΉ„μ–΄μμ");
            alert("μ¥λ°”κµ¬λ‹κ°€ λΉ„μ–΄μμµλ‹λ‹¤. μƒν’μ„ μ¶”κ°€ν•΄μ£Όμ„Έμ”.");
        }
    }
</script>
</body>
</html>